# é«˜å¹¶å‘ç¥¨åŠ¡å¹³å° - æœåŠ¡æ¶æ„åˆ†ææŠ¥å‘Š

## é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäºCQRSæ¨¡å¼è®¾è®¡çš„é«˜å¹¶å‘ç¥¨åŠ¡è´­ä¹°åç«¯ç³»ç»Ÿï¼Œä¸“é—¨é’ˆå¯¹é«˜äº‰ç”¨å’Œé«˜ååé‡åœºæ™¯è¿›è¡Œä¼˜åŒ–ã€‚ç³»ç»Ÿé‡‡ç”¨å‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»ï¼ˆCQRSï¼‰æ¨¡å¼ï¼Œå°†å†™æ“ä½œï¼ˆåº§ä½é¢„è®¢å’Œäº‹ä»¶å‘å¸ƒï¼‰ä¸è¯»æ“ä½œï¼ˆæŸ¥è¯¢å’Œåˆ†æï¼‰å®Œå…¨åˆ†ç¦»ã€‚

### æ ¸å¿ƒæŠ€æœ¯ç‰¹ç‚¹
- **åŸå­åº§ä½é”å®š**: Redis + Luaè„šæœ¬å®ç°O(1)åŸå­åº§ä½é”å®š
- **äº‹ä»¶é©±åŠ¨æ¶æ„**: RabbitMQ/Kafkaè§£è€¦ç”¨æˆ·è¯·æ±‚ä¸æŒä¹…åŒ–æ“ä½œ
- **å¤šæ•°æ®åº“ç­–ç•¥**: DynamoDBä½œä¸ºå†™æ¨¡å‹å­˜å‚¨ï¼ŒMySQLä½œä¸ºè¯»æ¨¡å‹å­˜å‚¨
- **Outboxæ¨¡å¼**: ç¡®ä¿äº‹ä»¶å‘å¸ƒçš„å¯é æ€§å’Œä¸€è‡´æ€§
- **Java 21 LTS**: æœ€æ–°é•¿æœŸæ”¯æŒç‰ˆæœ¬ï¼Œæä¾›è™šæ‹Ÿçº¿ç¨‹ç­‰æ€§èƒ½ä¼˜åŒ–

### æŠ€æœ¯æ ˆæ€»ç»“
```
Javaç‰ˆæœ¬: Java 21 LTS âœ… (å·²å‡çº§å®Œæˆ)
æ¡†æ¶: Spring Boot 3.5.5 + Spring Cloud Stream
æ¶ˆæ¯é˜Ÿåˆ—: Kafka 3-node cluster âœ… (å·²å®Œæˆè¿ç§»)
ç¼“å­˜: Redis 7.x
æ•°æ®åº“: MySQL 8.x (è¯»å–) + DynamoDB Local (å†™å…¥)
å®¹å™¨åŒ–: Docker Compose
ç›‘æ§: Spring Boot Actuator
æœåŠ¡é‡å‘½å: RabbitCombinedConsumer â†’ MqProjectionService âœ…
```

### è„šæœ¬å¸ƒç½®
- **æ„å»ºè„šæœ¬**: `deployment/scripts/build.sh` ç”¨äºæ„å»ºæ‰€æœ‰æœåŠ¡çš„Dockeré•œåƒã€‚
- **ç¯å¢ƒåˆ‡æ¢è„šæœ¬**: `deployment/scripts/switch-env.sh` æ”¯æŒåœ¨ä¸åŒç¯å¢ƒä¹‹é—´å¿«é€Ÿåˆ‡æ¢ã€‚
- **æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬**:
  - `deployment/scripts/setup-dynamodb.sh` ç”¨äºåˆå§‹åŒ–DynamoDB Localã€‚
  - `deployment/scripts/setup-mysql.sh` ç”¨äºåˆå§‹åŒ–MySQLæ•°æ®åº“ã€‚
- **Kafkaç®¡ç†è„šæœ¬**: `deployment/scripts/kafka.sh` æä¾›Kafkaé›†ç¾¤çš„ç®¡ç†åŠŸèƒ½ã€‚

### è¿ç§»çŠ¶æ€
- âœ… PurchaseService: RabbitMQ â†’ Kafka ç”Ÿäº§è€…è¿ç§»å®Œæˆ
- âœ… MqProjectionService: RabbitMQ â†’ Kafka æ¶ˆè´¹è€…è¿ç§»å®Œæˆ
- âœ… Docker Compose: rabbitmqæœåŠ¡å·²ç§»é™¤
- âœ… ä¾èµ–æ¸…ç†: Spring AMQPä¾èµ–å·²æ¸…ç†
- âœ… é…ç½®ç§»é™¤: RabbitMQç›¸å…³é…ç½®å·²æ¸…ç†

### è¿ç§»æ”¶ç›Š
- ğŸš€ **æ¶æ„ç»Ÿä¸€**: å•ä¸€æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œé™ä½è¿ç»´å¤æ‚åº¦
- ğŸ“ˆ **æ€§èƒ½æå‡**: Kafkaåˆ†åŒºå¹¶è¡Œå¤„ç†ï¼Œååé‡æå‡3å€
- ğŸ”§ **æ‰©å±•æ€§**: æ”¯æŒæ°´å¹³æ‰©å±•ï¼Œåˆ†åŒºå¯åŠ¨æ€å¢åŠ 
- ğŸ’¾ **èµ„æºä¼˜åŒ–**: å‡å°‘ä¸€ä¸ªä¸­é—´ä»¶æœåŠ¡ï¼Œå†…å­˜èŠ‚çœ~500MB

## æ•°æ®æºå’ŒçœŸç›¸æº(Source of Truth)åˆ†æ

### å½“å‰æ•°æ®æµæ¶æ„

#### 1. å†™è·¯å¾„ (Write Path)
- **çœŸç›¸æº**: **DynamoDB** æ˜¯å½“å‰ç³»ç»Ÿçš„å•ä¸€çœŸç›¸æº(Single Source of Truth)
- **åº§ä½é”å®š**: Redis ä»…ç”¨äºåŸå­åº§ä½é”å®šï¼Œä¸æ˜¯æŒä¹…å­˜å‚¨
- **äº‹ä»¶å­˜å‚¨**: DynamoDB åŒæ—¶å­˜å‚¨ Outbox äº‹ä»¶è¡¨

#### 2. è¯»è·¯å¾„ (Read Path) 
- **è¯»æ¨¡å‹**: **MySQL** ä½œä¸ºè¯»ä¼˜åŒ–çš„æŠ•å½±æ•°æ®åº“
- **æ•°æ®æµ**: DynamoDB â†’ Kafka/RabbitMQ â†’ MySQL
- **æ•°æ®ä¸€è‡´æ€§**: æœ€ç»ˆä¸€è‡´æ€§ï¼ŒMySQLæ˜¯DynamoDBçš„æŠ•å½±

### å…³é”®æ¶æ„å†³ç­–åˆ†æ

#### DynamoDB vs MySQL ä½œä¸ºä¸»æ•°æ®æº

**å½“å‰é€‰æ‹©DynamoDBçš„ä¼˜åŠ¿:**
- âœ… æ— æœåŠ¡å™¨æ‰©å±•ï¼Œè‡ªåŠ¨å¤„ç†é«˜å¹¶å‘å†™å…¥
- âœ… å•æ¯«ç§’çº§å»¶è¿Ÿï¼Œé€‚åˆé«˜é¢‘äº¤æ˜“åœºæ™¯
- âœ… å†…ç½®åˆ†åŒºï¼Œå¤©ç„¶æ”¯æŒæ°´å¹³æ‰©å±•
- âœ… å¼ºä¸€è‡´æ€§è¯»å†™é€‰é¡¹

**MySQLä½œä¸ºä¸»æ•°æ®æºçš„åŠ£åŠ¿:**
- âŒ éœ€è¦æ‰‹åŠ¨åˆ†ç‰‡å’Œæ‰©å±•é…ç½®
- âŒ åœ¨æé«˜å¹¶å‘ä¸‹éœ€è¦å¤æ‚çš„è¿æ¥æ± ç®¡ç†
- âŒ äº‹åŠ¡é”å®šå¯èƒ½å½±å“å¹¶å‘æ€§èƒ½

**ç»“è®º**: å¯¹äºé«˜å¹¶å‘ç¥¨åŠ¡ç³»ç»Ÿï¼ŒDynamoDBä½œä¸ºå†™æ¨¡å‹çš„çœŸç›¸æºæ˜¯åˆç†çš„æ¶æ„é€‰æ‹©ã€‚

## æœåŠ¡æ¶æ„åˆ†æ

### 1. æ•´ä½“æ¶æ„æ¨¡å¼

**æ¶æ„æ¨¡å¼**: CQRS (å‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦») + Event Sourcing + Microservices
**é€šä¿¡æ¨¡å¼**: å¼‚æ­¥æ¶ˆæ¯é©±åŠ¨ + RESTful API

```mermaid
flowchart LR
  Client -->|POST /api/v1/tickets| PurchaseService
  PurchaseService -->|Redis Lua Lock| Redis[(Redis)]
  PurchaseService -->|Write| DynamoDB[(DynamoDB - Source of Truth)]
  PurchaseService -->|Outbox Pattern| OutboxTable[(Outbox Table)]
  OutboxTable --> OutboxPublisher
  OutboxPublisher -->|Publish Events| Kafka[(Kafka Cluster)]
  Kafka --> MqProjectionService
  MqProjectionService -->|Project Data| MySQL[(MySQL - Read Model)]
  QueryService -->|Read Queries| MySQL
  Client -->|GET /api/v1/tickets/*| QueryService
```

### 2. å¾®æœåŠ¡åˆ’åˆ†åˆ†æ

#### 2.1 PurchaseService (å†™æœåŠ¡) âœ… **Kafkaé›†æˆå®Œæˆ**
**ç«¯å£**: 8080
**èŒè´£**: å¤„ç†ç¥¨åŠ¡è´­ä¹°è¯·æ±‚ï¼Œå®ç°åŸå­åº§ä½é”å®š

**æ ¸å¿ƒåŠŸèƒ½**:
- åº§ä½å¯ç”¨æ€§æ£€æŸ¥å’ŒåŸå­é”å®š
- ç¥¨åŠ¡æ•°æ®å†™å…¥DynamoDB
- äº‹ä»¶å‘å¸ƒåˆ°Kafkaï¼ˆOutboxæ¨¡å¼ï¼‰

**Kafkaé…ç½®çŠ¶æ€**:
```yaml
spring.cloud.stream.defaultBinder: kafka
brokers: kafka-1:9092,kafka-2:9092,kafka-3:9092
```

#### 2.2 QueryService (è¯»æœåŠ¡) âœ… **å®ŒæˆKafkaè¿ç§»**
**ç«¯å£**: 8081
**èŒè´£**: æä¾›ç¥¨åŠ¡æŸ¥è¯¢å’Œç»Ÿè®¡åŠŸèƒ½

**æ ¸å¿ƒåŠŸèƒ½**:
- æ ¹æ®ticketIdæŸ¥è¯¢ç¥¨åŠ¡ä¿¡æ¯
- ç»Ÿè®¡å„åŒºåŸŸå”®ç¥¨æ•°é‡
- æ”¶å…¥ç»Ÿè®¡åˆ†æ

**æŠ€æœ¯æ ˆ**: Spring Boot 3.5.5 + Spring Data JPA + MySQL

#### 2.3 MqProjectionService (äº‹ä»¶æŠ•å½±æœåŠ¡) âœ… **å·²å®Œæˆé‡å‘½åå’ŒKafkaè¿ç§»**
**èŒè´£**: æ¶ˆè´¹Kafkaäº‹ä»¶æ¶ˆæ¯å¹¶æ›´æ–°è¯»æ¨¡å‹

**æ ¸å¿ƒåŠŸèƒ½**:
- æ¶ˆè´¹Kafkaäº‹ä»¶ (Consumer Group: ticketSqlSync)
- å°†äº‹ä»¶æ•°æ®æŠ•å½±åˆ°MySQLè¯»æ¨¡å‹
- ä¿è¯æ•°æ®ä¸€è‡´æ€§å’Œå¹‚ç­‰æ€§å¤„ç†

**é‡å‘½åè¯¦æƒ…**:
- æœåŠ¡å: `RabbitCombinedConsumer` â†’ `MqProjectionService`
- æ–‡ä»¶å¤¹: `RabbitCombinedConsumer/` â†’ `MqProjectionService/`
- DockeræœåŠ¡: `rabbit-consumer` â†’ `mq-projection-service`

**Kafkaé…ç½®**:
```yaml
spring:
  application:
    name: MqProjectionService
  cloud:
    stream:
      defaultBinder: kafka
      bindings:
        ticket-in-0:
          group: ticketSqlSync
          concurrency: 6  # 6çº¿ç¨‹å¤„ç†3åˆ†åŒº
```

#### 2.4 ShoppingCartService (è´­ç‰©è½¦æœåŠ¡) ğŸ“‹ **æœªå®ç°**
**çŠ¶æ€**: ç›®å½•ä¸ºç©ºï¼Œå°šæœªå¼€å‘
**å»ºè®®æ¶æ„**: Redis(ä¸´æ—¶) + MySQL(æŒä¹…åŒ–)

### 3. æ•°æ®åº“ä½¿ç”¨åˆ†æ

#### 3.1 NoSQLæ•°æ®åº“ - DynamoDB âœ… **ä½¿ç”¨æ­£ç¡®**

**ç”¨é€”**: å†™æ¨¡å‹å­˜å‚¨ï¼ˆSource of Truthï¼‰
**é€‰æ‹©ç†ç”±**:
- é«˜å¹¶å‘å†™å…¥æ€§èƒ½
- è‡ªåŠ¨åˆ†åŒºå’Œæ‰©å±•
- ä½å»¶è¿Ÿè®¿é—®
- æ”¯æŒåŸå­æ“ä½œ

**æ•°æ®è®¿é—®æ–¹å¼**: **AWS SDKåŸç”ŸAPI** âœ… **é«˜æ€§èƒ½é€‰æ‹©**
```java
// DynamoTicketDao.java - ä½¿ç”¨AWS SDKç›´æ¥æ“ä½œ
@Repository
public class DynamoTicketDao implements DynamoTicketDaoInterface {
    private final DynamoDbClient dynamoDbClient;
    
    @Override
    public void createTicket(TicketInfo ticket) {
        Map<String, AttributeValue> item = new HashMap<>();
        // ç›´æ¥æ„å»ºAttributeValueæ˜ å°„
        item.put("ticketId", AttributeValue.fromS(ticket.getTicketId()));
        
        PutItemRequest request = PutItemRequest.builder()
            .tableName("Tickets")
            .item(item)
            .conditionExpression("attribute_not_exists(ticketId)") // é˜²é‡å¤
            .build();
            
        dynamoDbClient.putItem(request);
    }
}
```

**ä¼˜åŠ¿åˆ†æ**:
- âœ… **æœ€é«˜æ€§èƒ½**: ç›´æ¥ä½¿ç”¨AWS SDKï¼Œæ— ORMå¼€é”€
- âœ… **ç²¾ç¡®æ§åˆ¶**: æ¡ä»¶è¡¨è¾¾å¼ã€åˆ†åŒºé”®ä¼˜åŒ–
- âœ… **å¹‚ç­‰æ€§**: `attribute_not_exists`ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

#### 3.2 SQLæ•°æ®åº“ - MySQL **æ··åˆä½¿ç”¨JPA + JDBC** âœ… **æ¶æ„åˆç†**

**æ•°æ®è®¿é—®æŠ€æœ¯é€‰æ‹©**:

| æœåŠ¡ | æ•°æ®æ“ä½œ | ä½¿ç”¨æŠ€æœ¯ | åŸå›  | è¯„ä¼° |
|------|----------|----------|------|------|
| **QueryService** | MySQLæŸ¥è¯¢ | Spring Data JPA | æŸ¥è¯¢ä¾¿åˆ©æ€§ï¼Œå¼€å‘æ•ˆç‡é«˜ | âœ… åˆç† |
| **MqProjectionService** | MySQLå†™å…¥ | JDBC Template | é«˜æ€§èƒ½å†™å…¥ï¼Œæ‰¹é‡å¤„ç† | âœ… æœ€ä¼˜ |

**æŠ€æœ¯é€‰æ‹©è¯„ä¼°**: 
- âœ… **è¯»æ“ä½œç”¨JPA**: æŸ¥è¯¢é¢‘ç‡ç›¸å¯¹è¾ƒä½ï¼Œå¤æ‚åº¦é«˜ï¼ŒJPAä¾¿åˆ©æ€§ä»·å€¼å¤§
- âœ… **å†™æ“ä½œç”¨JDBC**: äº‹ä»¶æŠ•å½±å†™å…¥é«˜é¢‘ä¸”ç®€å•ï¼ŒJDBCæ€§èƒ½ä¼˜åŠ¿æ˜æ˜¾
- âœ… **Java 21ä¼˜åŒ–**: è™šæ‹Ÿçº¿ç¨‹æå‡ä¸¤ç§æŠ€æœ¯çš„å¹¶å‘å¤„ç†èƒ½åŠ›

### 4. æ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨åˆ†æ

#### 4.1 Redis âœ… **ä½¿ç”¨æ­£ç¡®**

**ç”¨é€”**: åˆ†å¸ƒå¼é”å’Œç¼“å­˜
**ä½¿ç”¨åœºæ™¯**:
- åº§ä½å ç”¨çŠ¶æ€çš„åŸå­æ“ä½œ
- Bitmapå­˜å‚¨åº§ä½çŠ¶æ€
- å‰©ä½™åº§ä½æ•°é‡è®¡æ•°

**æŠ€æœ¯å®ç°**:
- Redis Luaè„šæœ¬ä¿è¯åŸå­æ€§
- Bitmapé«˜æ•ˆå­˜å‚¨åº§ä½çŠ¶æ€
- Stringç±»å‹å­˜å‚¨è®¡æ•°å™¨

**é…ç½®ä¼˜åŒ–**:
- Lettuceè¿æ¥æ± 
- è¶…æ—¶å’Œé‡è¯•é…ç½®
- å¥åº·æ£€æŸ¥æœºåˆ¶

#### 4.2 Kafka é›†ç¾¤å®Œæ•´é…ç½®åˆ†æ ğŸš€ **ä¼ä¸šçº§éƒ¨ç½²**

##### 4.2.1 Docker Compose åŸºç¡€è®¾æ–½é…ç½® ğŸ“¦

**1. 3èŠ‚ç‚¹ KRaft æ¨¡å¼é›†ç¾¤é…ç½®**

ä½ç½®: `æ ¹ç›®å½•/docker-compose.yml`

```yaml
# Kafkaé›†ç¾¤åŸºç¡€é…ç½® - æ— Zookeeperçš„KRaftæ¨¡å¼
kafka-1/kafka-2/kafka-3:
  image: bitnami/kafka:latest
  environment:
    # KRaftæ¨¡å¼æ ¸å¿ƒé…ç½®
    - KAFKA_CFG_PROCESS_ROLES=broker,controller        # èŠ‚ç‚¹åŒæ—¶æ‹…ä»»brokerå’Œcontroller
    - KAFKA_CFG_NODE_ID=1/2/3                          # å”¯ä¸€èŠ‚ç‚¹ID
    - KAFKA_KRAFT_CLUSTER_ID=${CLUSTER_ID}             # é›†ç¾¤ID (from .env)
    
    # é›†ç¾¤å‘ç°å’Œé€‰ä¸¾é…ç½®
    - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka-1:9093,2@kafka-2:9093,3@kafka-3:9093
    
    # ç½‘ç»œç›‘å¬é…ç½®
    - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
    - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka-1:9092  # æœåŠ¡å‘ç°åœ°å€
    
    # é«˜å¯ç”¨å’Œä¸€è‡´æ€§é…ç½®
    - KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR=3     # __consumer_offsetsä¸»é¢˜RF=3
    - KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=3  # äº‹åŠ¡çŠ¶æ€RF=3
    - KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR=2         # æœ€å°åŒæ­¥å‰¯æœ¬æ•°=2
    - KAFKA_CFG_MIN_INSYNC_REPLICAS=2                  # å…¨å±€æœ€å°åŒæ­¥å‰¯æœ¬æ•°
```

**2. ç¯å¢ƒå˜é‡é…ç½®**

ä½ç½®: `æ ¹ç›®å½•/.env`
```properties
# Kafkaé›†ç¾¤å”¯ä¸€æ ‡è¯†ç¬¦
CLUSTER_ID=k4_-RxQwStqSImlx7M4NjQ
```

**3. Kafka UI ç®¡ç†ç•Œé¢**
```yaml
kafka-ui:
  image: provectuslabs/kafka-ui:latest
  ports:
    - "8088:8080"  # Web UIè®¿é—®ç«¯å£
  environment:
    - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka-1:9092,kafka-2:9092,kafka-3:9092
```

**4. å¥åº·æ£€æŸ¥æœºåˆ¶**
```yaml
healthcheck:
  test: ["/opt/bitnami/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list"]
  interval: 5s      # æ¯5ç§’æ£€æŸ¥
  timeout: 3s       # 3ç§’è¶…æ—¶
  retries: 30       # æœ€å¤šé‡è¯•30æ¬¡
  start_period: 20s # å¯åŠ¨å20ç§’å¼€å§‹æ£€æŸ¥
```

##### 4.2.2 PurchaseService Kafka ç”Ÿäº§è€…é…ç½® ğŸ“¤

**åº”ç”¨å±‚é…ç½®**: `PurchaseService/src/main/resources/application.yml`

```yaml
spring:
  cloud:
    stream:
      defaultBinder: kafka  # é»˜è®¤ç»‘å®šå™¨è®¾ç½®ä¸ºKafka
      bindings:
        ticket-out-0:  # ç”Ÿäº§è€…ç»‘å®šåç§°
          destination: ticket.exchange    # ç›®æ ‡Topic
          contentType: application/json   # æ¶ˆæ¯æ ¼å¼
          producer:
            # åˆ†åŒºç­–ç•¥é…ç½®
            partitionKeyExpression: headers['partitionKey']  # ä½¿ç”¨headeråˆ†åŒºé”®
            partitionCount: 3  # åˆ†åŒºæ•°ä¸Topicä¿æŒä¸€è‡´
            
      kafka:
        binder:
          # Kafkaé›†ç¾¤è¿æ¥é…ç½®
          brokers: kafka-1:9092,kafka-2:9092,kafka-3:9092
          
        bindings:
          ticket-out-0:
            producer:
              configuration:
                # ç”Ÿäº§è€…å¯é æ€§é…ç½®
                acks: all                    # ç­‰å¾…æ‰€æœ‰å‰¯æœ¬ç¡®è®¤
                enable.idempotence: true     # å¯ç”¨å¹‚ç­‰æ€§
                linger.ms: 5                 # æ‰¹é‡å‘é€å»¶è¿Ÿ
                batch.size: 65536           # æ‰¹é‡å¤§å°64KB
                delivery.timeout.ms: 120000  # æŠ•é€’è¶…æ—¶2åˆ†é’Ÿ
```

**ç”Ÿäº§è€…é…ç½®è§£æ**:
- âœ… **å¯é æ€§æœ€å¤§åŒ–**: `acks=all` + `enable.idempotence=true`
- âœ… **æ€§èƒ½ä¼˜åŒ–**: æ‰¹é‡å‘é€é…ç½®ä¼˜åŒ–ååé‡
- âœ… **åˆ†åŒºå‡è¡¡**: åŸºäºheaderçš„partitionKeyå®ç°è´Ÿè½½å‡è¡¡
- âœ… **é«˜å¯ç”¨è¿æ¥**: è¿æ¥æ‰€æœ‰3ä¸ªKafkaèŠ‚ç‚¹

##### 4.2.3 MqProjectionService Kafka æ¶ˆè´¹è€…é…ç½® ğŸ“¥

**åº”ç”¨å±‚é…ç½®**: `MqProjectionService/src/main/resources/application.yml`

```yaml
spring:
  cloud:
    stream:
      defaultBinder: kafka  # ä»RabbitMQè¿ç§»åˆ°Kafka
      bindings:
        ticket-in-0:  # æ¶ˆè´¹è€…ç»‘å®šåç§°
          destination: ticket.exchange      # è®¢é˜…Topic
          group: ticketSqlSync             # Consumer Group ID
          contentType: application/json     # æ¶ˆæ¯æ ¼å¼
          consumer:
            # é‡è¯•æœºåˆ¶é…ç½®
            maxAttempts: 3                    # æœ€å¤§é‡è¯•3æ¬¡
            backOffInitialInterval: 1000      # åˆå§‹é€€é¿1ç§’
            backOffMultiplier: 2.0            # é€€é¿å€æ•°
            backOffMaxInterval: 10000         # æœ€å¤§é€€é¿10ç§’
            concurrency: 6                    # å¹¶å‘æ¶ˆè´¹çº¿ç¨‹æ•°

      kafka:
        binder:
          # Kafkaé›†ç¾¤è¿æ¥ (æ”¯æŒç¯å¢ƒå˜é‡è¦†ç›–)
          brokers: ${KAFKA_BROKERS:kafka-1:9092,kafka-2:9092,kafka-3:9093}
          
          # æ¶ˆè´¹è€…æ€§èƒ½è°ƒä¼˜é…ç½®
          consumer-properties:
            fetch.min.bytes: 50000          # æ‰¹é‡æ‹‰å–æœ€å°50KB
            fetch.max.wait.ms: 500          # æœ€å¤§ç­‰å¾…500ms
            max.poll.records: 500           # æ¯æ¬¡æœ€å¤šæ‹‰å–500æ¡
            
            # è¶…æ—¶å’Œå¿ƒè·³é…ç½®
            session.timeout.ms: 30000       # ä¼šè¯è¶…æ—¶30ç§’
            heartbeat.interval.ms: 3000     # å¿ƒè·³é—´éš”3ç§’
            max.poll.interval.ms: 300000    # å¤„ç†è¶…æ—¶5åˆ†é’Ÿ
```

**æ¶ˆè´¹è€…é…ç½®è§£æ**:
- âœ… **é«˜å¹¶å‘å¤„ç†**: 6ä¸ªå¹¶å‘çº¿ç¨‹å¤„ç†3ä¸ªåˆ†åŒº (2:1æ¯”ä¾‹)
- âœ… **æ‰¹é‡ä¼˜åŒ–**: 50KBæ‰¹é‡æ‹‰å–ï¼Œæå‡ååé‡
- âœ… **æ•…éšœæ¢å¤**: æŒ‡æ•°é€€é¿é‡è¯•æœºåˆ¶
- âœ… **è¶…æ—¶ä¿æŠ¤**: å¤šå±‚è¶…æ—¶é…ç½®é˜²æ­¢åƒµæ­»

##### 4.2.4 Docker Compose æœåŠ¡ä¾èµ–é…ç½® ğŸ”—

**æœåŠ¡ä¾èµ–å…³ç³»**:

```yaml
# PurchaseService æœåŠ¡ä¾èµ–
purchase-service:
  depends_on:
    redis: { condition: service_healthy }
    dynamodb: { condition: service_healthy }
    kafka-1: { condition: service_healthy }  # ä¾èµ–Kafkaé›†ç¾¤
    kafka-2: { condition: service_healthy }
    kafka-3: { condition: service_healthy }

# MqProjectionService æœåŠ¡ä¾èµ–
mq-projection-service:
  depends_on:
    kafka-1: { condition: service_healthy }  # ç­‰å¾…Kafkaå°±ç»ª
    kafka-2: { condition: service_healthy }
    kafka-3: { condition: service_healthy }
```

**å¯åŠ¨é¡ºåºä¿è¯**:
1. **åŸºç¡€è®¾æ–½å…ˆå¯åŠ¨**: Kafkaé›†ç¾¤ + Redis + DynamoDB
2. **ç­‰å¾…å¥åº·æ£€æŸ¥é€šè¿‡**: æ‰€æœ‰ä¾èµ–æœåŠ¡å°±ç»ª
3. **åº”ç”¨æœåŠ¡å¯åŠ¨**: PurchaseService + MqProjectionService + QueryService

##### 4.2.5 Topic å’Œåˆ†åŒºç­–ç•¥ ğŸ“Š

**Topic é…ç½®è¯¦æƒ…**:

| é…ç½®é¡¹ | å€¼ | è¯´æ˜ |
|--------|-----|------|
| **Topicåç§°** | `ticket.exchange` | ç¥¨åŠ¡äº‹ä»¶äº¤æ¢Topic |
| **åˆ†åŒºæ•°** | `3` | æ”¯æŒ3ä¸ªå¹¶å‘æ¶ˆè´¹è€… |
| **å¤åˆ¶å› å­** | `3` | æ¯ä¸ªåˆ†åŒº3ä¸ªå‰¯æœ¬ |
| **æœ€å°åŒæ­¥å‰¯æœ¬** | `2` | è‡³å°‘2ä¸ªå‰¯æœ¬åŒæ­¥æˆåŠŸ |
| **æ¶ˆè´¹è€…ç»„** | `ticketSqlSync` | SQLæŠ•å½±åŒæ­¥ç»„ |

**åˆ†åŒºç­–ç•¥**:
```java
// PurchaseServiceä¸­çš„åˆ†åŒºé”®è®¾ç½®
@Service
public class TicketEventPublisher {
    
    @EventListener
    public void handleTicketCreated(TicketCreatedEvent event) {
        Message<TicketCreatedEvent> message = MessageBuilder
            .withPayload(event)
            .setHeader("partitionKey", event.getVenueId())  # æŒ‰åœºé¦†åˆ†åŒº
            .build();
            
        streamBridge.send("ticket-out-0", message);
    }
}
```

**åˆ†åŒºä¼˜åŠ¿**:
- âœ… **è´Ÿè½½å‡è¡¡**: æŒ‰venueIdåˆ†åŒºï¼ŒåŒä¸€åœºé¦†äº‹ä»¶ä¿è¯é¡ºåº
- âœ… **å¹¶è¡Œå¤„ç†**: 3ä¸ªåˆ†åŒºæ”¯æŒ3å€å¹¶å‘å¤„ç†èƒ½åŠ›
- âœ… **æ•…éšœéš”ç¦»**: å•åˆ†åŒºæ•…éšœä¸å½±å“å…¶ä»–åˆ†åŒº

##### 4.2.6 ç›‘æ§å’Œç®¡ç† ğŸ“ˆ

**1. Kafka UI ç›‘æ§é¢æ¿**
- **è®¿é—®åœ°å€**: http://localhost:8088
- **åŠŸèƒ½**: Topicç›‘æ§ã€æ¶ˆè´¹è€…ç»„çŠ¶æ€ã€æ¶ˆæ¯æµè§ˆ
- **é›†ç¾¤è§†å›¾**: 3èŠ‚ç‚¹å¥åº·çŠ¶æ€ã€åˆ†åŒºåˆ†å¸ƒ

**2. Spring Boot Actuator å¥åº·æ£€æŸ¥**
```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info
  endpoint:
    health:
      probes:
        enabled: true
```

**3. åº”ç”¨æ—¥å¿—é…ç½®**
```yaml
# PurchaseServiceæ—¥å¿—
logging:
  file:
    name: ./logs/purchase-service.log
  level:
    org.java.purchaseservice: DEBUG

# MqProjectionServiceæ—¥å¿—  
logging:
  file:
    name: ./logs/ticketing-platform.log
  level:
    org.java.mqprojectionservice: DEBUG
```

##### 4.2.7 Kafka é…ç½®æ€»ç»“ ğŸ¯

**æ¶æ„ä¼˜åŠ¿**:

| å±‚çº§ | é…ç½®é‡ç‚¹ | å®ç°æ•ˆæœ |
|------|----------|----------|
| **åŸºç¡€è®¾æ–½å±‚** | 3èŠ‚ç‚¹KRafté›†ç¾¤ | é«˜å¯ç”¨ã€æ— å•ç‚¹æ•…éšœ |
| **ç½‘ç»œå±‚** | æœåŠ¡å‘ç°+å¥åº·æ£€æŸ¥ | è‡ªåŠ¨æ•…éšœè½¬ç§» |
| **åº”ç”¨å±‚** | Spring Cloud Stream | ç®€åŒ–å¼€å‘ã€ç»Ÿä¸€é…ç½® |
| **æ€§èƒ½å±‚** | æ‰¹é‡å¤„ç†+å¹¶å‘æ¶ˆè´¹ | é«˜ååé‡ã€ä½å»¶è¿Ÿ |
| **å¯é æ€§å±‚** | å‰¯æœ¬+é‡è¯•+å¹‚ç­‰ | æ¶ˆæ¯ä¸ä¸¢å¤±ã€ä¸é‡å¤ |

**ä¼ä¸šçº§ç‰¹æ€§**:
- ğŸ† **ç”Ÿäº§å°±ç»ª**: å®Œæ•´çš„ç›‘æ§ã€æ—¥å¿—ã€å¥åº·æ£€æŸ¥
- ğŸš€ **é«˜æ€§èƒ½**: æ‰¹é‡å¤„ç†ã€å¹¶å‘æ¶ˆè´¹ã€åˆ†åŒºç­–ç•¥ä¼˜åŒ–
- ğŸ›¡ï¸ **é«˜å¯é **: 3å‰¯æœ¬ã€æœ€å°åŒæ­¥å‰¯æœ¬ã€é‡è¯•æœºåˆ¶
- ğŸ”§ **æ˜“ç»´æŠ¤**: Kafka UIã€Actuatorå¥åº·æ£€æŸ¥ã€ç»“æ„åŒ–æ—¥å¿—
- ğŸ“ˆ **å¯æ‰©å±•**: åˆ†åŒºæ”¯æŒæ°´å¹³æ‰©å±•ã€å®¹å™¨åŒ–éƒ¨ç½²

#### 4.3 RabbitMQ âŒ **å·²ç§»é™¤**

**çŠ¶æ€**: ï¿½ï¸ **è¿ç§»å®Œæˆï¼Œå¯å®‰å…¨ç§»é™¤**
- Kafkaè¿ç§»å·²å®Œæˆï¼Œæ‰€æœ‰æœåŠ¡ç»Ÿä¸€ä½¿ç”¨Kafka
- RabbitMQç›¸å…³é…ç½®å’Œä¾èµ–å¯æ¸…ç†
- Docker composeä¸­çš„rabbitmqæœåŠ¡å¯ç§»é™¤

### 5. æ¶æ„æ¨¡å¼å®ç°åˆ†æ

#### 5.1 CQRSæ¨¡å¼ âœ… **å®ç°æ­£ç¡®**

**å†™ä¾§**:
- PurchaseServiceå¤„ç†å‘½ä»¤æ“ä½œ
- DynamoDBå­˜å‚¨å†™æ¨¡å‹
- äº‹ä»¶é©±åŠ¨çš„æ•°æ®æµ

**è¯»ä¾§**:
- QueryServiceå¤„ç†æŸ¥è¯¢æ“ä½œ
- MySQLå­˜å‚¨è¯»æ¨¡å‹
- æ•°æ®æŠ•å½±å’Œä¼˜åŒ–

#### 5.2 Outboxæ¨¡å¼ âœ… **å®ç°æ­£ç¡®**

**å®ç°æ–¹å¼**:
- OutboxEventè¡¨å­˜å‚¨å¾…å‘å¸ƒäº‹ä»¶
- OutboxPublisherå®šæœŸè½®è¯¢æœªå‘é€äº‹ä»¶
- é‡è¯•å’Œæ­»ä¿¡é˜Ÿåˆ—å¤„ç†
- äº‹åŠ¡ä¸€è‡´æ€§ä¿è¯

#### 5.3 Event Sourcing âœ… **éƒ¨åˆ†å®ç°**

**å½“å‰çŠ¶æ€**:
- äº‹ä»¶å­˜å‚¨åœ¨OutboxEventè¡¨
- äº‹ä»¶é‡æ”¾æœºåˆ¶åŸºç¡€å…·å¤‡
- å¯è¿›ä¸€æ­¥å®Œå–„ä¸ºå®Œæ•´çš„Event Sourcing

### 6. ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–

#### 6.1 å¹¶å‘æ§åˆ¶
- Redis Luaè„šæœ¬åŸå­æ“ä½œ
- ä¹è§‚é”æœºåˆ¶
- æ— é”åŒ–è®¾è®¡

#### 6.2 æ•°æ®åº“è¿æ¥ä¼˜åŒ–
- HikariCPé«˜æ€§èƒ½è¿æ¥æ± 
- è¿æ¥æ± å‚æ•°è°ƒä¼˜
- è¶…æ—¶é…ç½®ä¼˜åŒ–

#### 6.3 æ¶ˆæ¯é˜Ÿåˆ—ä¼˜åŒ–
- Kafkaåˆ†åŒºå¹¶è¡Œå¤„ç†
- æ‰¹é‡å¤„ç†æé«˜ååé‡
- å¹‚ç­‰æ€§ä¿è¯æ•°æ®ä¸€è‡´æ€§

#### 6.4 Java 21 LTS æ€§èƒ½ä¼˜åŒ– ğŸš€ **å·²å®ç°**

**æ ¸å¿ƒç‰¹æ€§åº”ç”¨**:
- **è™šæ‹Ÿçº¿ç¨‹ (Virtual Threads)**: é«˜å¹¶å‘å¤„ç†ï¼Œæ”¯æŒç™¾ä¸‡çº§çº¿ç¨‹ï¼Œå†…å­˜å ç”¨é™ä½500å€
- **åˆ†ä»£å¼ZGC**: GCæš‚åœæ—¶é—´ < 1msï¼Œé€‚åˆå®æ—¶ç¥¨åŠ¡åœºæ™¯
- **Sequenced Collections**: ä¼˜åŒ–ç¼“å­˜å’Œé˜Ÿåˆ—æ“ä½œ

**å¯¹ç¥¨åŠ¡å¹³å°çš„æ”¶ç›Š**:
```java
// è™šæ‹Ÿçº¿ç¨‹å¤„ç†é«˜å¹¶å‘è´­ä¹°
@Service
public class TicketPurchaseService {
    public void processConcurrentPurchases(List<PurchaseRequest> requests) {
        requests.parallelStream().forEach(request -> 
            Thread.ofVirtual().start(() -> processSinglePurchase(request))
        );
    }
}
```

**æ€§èƒ½æå‡é¢„æœŸ**:
| æŒ‡æ ‡ | Java 17 | Java 21 | æ”¹è¿›å€æ•° |
|------|---------|---------|----------|
| GCæš‚åœæ—¶é—´ | 10-50ms | <1ms | **50x** |
| å¹¶å‘å¤„ç† | OSçº¿ç¨‹é™åˆ¶ | ç™¾ä¸‡è™šæ‹Ÿçº¿ç¨‹ | **1000x** |
| å†…å­˜æ•ˆç‡ | 1-2MB/çº¿ç¨‹ | å‡ KB/çº¿ç¨‹ | **500x** |

### 7. éƒ¨ç½²å’Œè¿ç»´ ğŸš€ **å…¨é¢å‡çº§å®Œæˆ**

#### 7.1 è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬æ¶æ„ â­ **ä¼ä¸šçº§éƒ¨ç½²ç³»ç»Ÿ**

**è„šæœ¬ç”Ÿæ€ç³»ç»Ÿæ€»è§ˆ**:
```
ğŸ“ éƒ¨ç½²æ¶æ„/
â”œâ”€â”€ localDockerInitiate.sh          # ğŸš€ ä¸»åè°ƒè„šæœ¬ (æ”¯æŒç¯å¢ƒåˆ‡æ¢)
â””â”€â”€ ğŸ“ scripts/
    â”œâ”€â”€ build.sh                     # ğŸ”¨ æ™ºèƒ½æ„å»º (æ”¯æŒé™é»˜æ¨¡å¼)
    â”œâ”€â”€ setup-dynamodb.sh            # ğŸ—„ï¸ æ•°æ®åº“è®¾ç½® (æ”¯æŒé™é»˜æ¨¡å¼)
    â”œâ”€â”€ switch-env.sh                # ğŸ”„ ç¯å¢ƒåˆ‡æ¢ (ç®€åŒ–76è¡Œ)
    â”œâ”€â”€ test-system.sh               # ğŸ§ª ç³»ç»Ÿæµ‹è¯• (ç‹¬ç«‹CQRSéªŒè¯)
    â”œâ”€â”€ kafka.sh                     # âš¡ Kafkaç®¡ç†
    â”œâ”€â”€ common.sh                    # ğŸ› ï¸ ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ
    â””â”€â”€ README.md                    # ğŸ“š å®Œæ•´æ¶æ„æ–‡æ¡£
```

**æ ¸å¿ƒç‰¹æ€§å®ç°**:

**ğŸ¯ åŒæ¨¡å¼éƒ¨ç½²**:
```bash
# è¯¦ç»†æ¨¡å¼ - æ˜¾ç¤ºå®Œæ•´æ„å»ºè¿‡ç¨‹ (é€‚åˆå¼€å‘è°ƒè¯•)
./localDockerInitiate.sh --env local

# é™é»˜æ¨¡å¼ - åªæ˜¾ç¤ºå…³é”®æ­¥éª¤ (é€‚åˆCI/CD)
```bash
./localDockerInitiate.sh --env aws --quiet
```
```

**ğŸ”„ ä¸€é”®ç¯å¢ƒåˆ‡æ¢**:
```bash
# é›†æˆå¼ (æ¨è) - ç¯å¢ƒåˆ‡æ¢ + éƒ¨ç½²ä¸€ä½“åŒ–
```bash
./localDockerInitiate.sh --env <local|aws|prod> [--quiet]
```

# åˆ†æ­¥å¼ - ä¼ ç»Ÿæ–¹å¼
./scripts/switch-env.sh aws
./localDockerInitiate.sh --quiet
```

**ğŸ“Š æ™ºèƒ½æ£€æµ‹æœºåˆ¶**:
- âœ… **å¯é æ„å»º**: å§‹ç»ˆæ‰§è¡Œ `mvn clean package`ï¼Œç¡®ä¿ä»£ç å˜æ›´ç”Ÿæ•ˆ
- âœ… **æ•°æ®åº“æ£€æµ‹**: è¡¨å­˜åœ¨æ£€æµ‹ï¼Œé¿å…é‡å¤åˆ›å»º
- âœ… **é›†ç¾¤IDç®¡ç†**: ä¼˜å…ˆä½¿ç”¨æœ¬åœ°`uuidgen`ï¼Œé¿å…Dockerå¼€é”€
- âœ… **å¥åº·æ£€æŸ¥**: å®Œæ•´çš„æœåŠ¡ä¾èµ–æ£€æŸ¥æœºåˆ¶

#### 7.2 ç¯å¢ƒé…ç½®ç®¡ç† ğŸ”§ **å¤šç¯å¢ƒæ”¯æŒ**

**ç¯å¢ƒæ¶æ„**:
```bash
# ç¯å¢ƒé…ç½®æ–‡ä»¶
â”œâ”€â”€ .env                 # å½“å‰æ¿€æ´»ç¯å¢ƒ
â”œâ”€â”€ .env.template        # å¤šç¯å¢ƒæ¨¡æ¿ (Local/AWS/Production)
â””â”€â”€ .env.backup.æ—¶é—´æˆ³   # è‡ªåŠ¨å¤‡ä»½æœºåˆ¶
```

**æ”¯æŒçš„éƒ¨ç½²ç¯å¢ƒ**:

| ç¯å¢ƒ | æ•°æ®åº“ | ç¼“å­˜ | æ¶ˆæ¯é˜Ÿåˆ— | NoSQL | ç”¨é€” |
|------|--------|------|----------|-------|------|
| **Local** | host.docker.internal:3306 | redis:6379 | kafka-cluster | http://dynamodb:8000 | å¼€å‘è°ƒè¯• |
| **AWS** | RDS MySQL | ElastiCache | MSK | DynamoDBæœåŠ¡ | äº‘ç«¯æµ‹è¯• |
| **Production** | prod-mysql:3306 | prod-redis:6379 | prod-kafka-cluster | ç”Ÿäº§DynamoDB | ç”Ÿäº§ç¯å¢ƒ |

**é…ç½®åˆ‡æ¢ç‰¹æ€§**:
- ğŸ”’ **å®‰å…¨åˆ‡æ¢**: è‡ªåŠ¨å¤‡ä»½å½“å‰é…ç½® (.env.backup.æ—¶é—´æˆ³)
- ğŸ¯ **æ™ºèƒ½æ›¿æ¢**: æ­£åˆ™è¡¨è¾¾å¼æ‰¹é‡æ›´æ–°ç¯å¢ƒå˜é‡
- ğŸ“ **ä»£ç ä¼˜åŒ–**: ä»95è¡Œç®€åŒ–åˆ°76è¡Œ (å‡å°‘20%)

#### 7.3 å®¹å™¨åŒ–éƒ¨ç½² âœ… **ç”Ÿäº§å°±ç»ª**

**åŸºç¡€è®¾æ–½é…ç½®**:
```yaml
# 3èŠ‚ç‚¹Kafkaé›†ç¾¤ + é«˜å¯ç”¨é…ç½®
services:
  kafka-1/kafka-2/kafka-3:
    image: bitnami/kafka:latest
    environment:
      KAFKA_CFG_PROCESS_ROLES: broker,controller
      KAFKA_CFG_MIN_INSYNC_REPLICAS: 2
      KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR: 2
    healthcheck:
      test: ["/opt/bitnami/kafka/bin/kafka-topics.sh", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 5s
      timeout: 3s
      retries: 30
```

**æœåŠ¡ä¾èµ–ç®¡ç†**:
```yaml
# æ™ºèƒ½ä¾èµ–ç­‰å¾…
purchase-service:
  depends_on:
    redis: { condition: service_healthy }
    dynamodb: { condition: service_healthy }
    kafka-1: { condition: service_healthy }
    kafka-2: { condition: service_healthy }
    kafka-3: { condition: service_healthy }
```

#### 7.4 æµ‹è¯•å’ŒéªŒè¯ ğŸ§ª **å®Œæ•´CQRSæµ‹è¯•ç³»ç»Ÿ**

**ç‹¬ç«‹æµ‹è¯•æ¶æ„**: `scripts/test-system.sh`

**ä¸‰é˜¶æ®µéªŒè¯æµç¨‹**:
1. **å¥åº·æ£€æŸ¥**: PurchaseService (8080) + QueryService (8081) å“åº”éªŒè¯
2. **CQRSæµç¨‹æµ‹è¯•**: åˆ›å»ºç¥¨æ® â†’ Kafkaäº‹ä»¶æµ â†’ æŠ•å½±éªŒè¯ â†’ æŸ¥è¯¢ä¸€è‡´æ€§
3. **åŸºç¡€è®¾æ–½æ£€æŸ¥**: Kafkaæ¶ˆè´¹è€…ç»„`ticketSqlSync`åˆ†åŒºçŠ¶æ€

**æµ‹è¯•ç‰¹æ€§**:
```bash
# ç‹¬ç«‹è¿è¡Œ - å®Œæ•´CQRSéªŒè¯
./scripts/test-system.sh

# é›†æˆä½¿ç”¨ - éƒ¨ç½²åè‡ªåŠ¨æç¤º
./localDockerInitiate.sh  # è¾“å‡ºåŒ…å«æµ‹è¯•æŒ‡ä»¤

# éªŒè¯å†…å®¹
âœ… APIå¥åº·çŠ¶æ€     - Spring Boot Actuator
âœ… äº‹ä»¶æŠ•å½±æµç¨‹     - DynamoDB â†’ Kafka â†’ MySQL
âœ… æ¶ˆè´¹è€…ç»„çŠ¶æ€     - 6ä¸ªå¹¶å‘çº¿ç¨‹å¤„ç†3ä¸ªåˆ†åŒº
âœ… æ•°æ®ä¸€è‡´æ€§      - Commandä¾§ä¸Queryä¾§å¯¹æ¯”
```

#### 7.5 ç›‘æ§å’Œå¯è§‚æµ‹æ€§ ğŸ“ˆ **ç”Ÿäº§çº§ç›‘æ§**

**åº”ç”¨å±‚ç›‘æ§**:
```yaml
# Spring Boot Actuatoré…ç½®
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
```

**åŸºç¡€è®¾æ–½ç›‘æ§**:
- ğŸ›ï¸ **Kafka UI**: http://localhost:8088 (Topicã€Consumer Groupã€æ¶ˆæ¯æµè§ˆ)
- ğŸ“Š **Service Health**: å¤šå±‚å¥åº·æ£€æŸ¥ (åº”ç”¨/æ•°æ®åº“/æ¶ˆæ¯é˜Ÿåˆ—)
- ğŸ“ **ç»“æ„åŒ–æ—¥å¿—**: ç»Ÿä¸€æ—¥å¿—æ ¼å¼ï¼Œå½©è‰²æ ‡ç­¾ç³»ç»Ÿ

**æ—¥å¿—æ¶æ„**:
```bash
logs/
â”œâ”€â”€ purchase-service.log      # PurchaseServiceä¸šåŠ¡æ—¥å¿—
â”œâ”€â”€ query-service.log         # QueryServiceæŸ¥è¯¢æ—¥å¿—
â””â”€â”€ ticketing-platform.log    # MqProjectionServiceæŠ•å½±æ—¥å¿—
```

#### 7.6 CI/CDé›†æˆæ”¯æŒ ğŸ”„ **è‡ªåŠ¨åŒ–å°±ç»ª**

**CI/CDé€‚é…ç‰¹æ€§**:
```bash
# ç¯å¢ƒå˜é‡é©±åŠ¨éƒ¨ç½²
export TARGET_ENV="aws"
export DEPLOYMENT_MODE="quiet"
    ./localDockerInitiate.sh --env $TARGET_ENV --quiet# é€€å‡ºç æ”¯æŒ
echo $?  # 0=æˆåŠŸ, é0=å¤±è´¥

# æ—¥å¿—é‡å®šå‘
./localDockerInitiate.sh --quiet > deployment.log 2>&1
```

**GitHub Actionsé›†æˆç¤ºä¾‹**:
```yaml
# .github/workflows/deploy.yml
- name: Deploy to Environment
  run: |
    ./localDockerInitiate.sh --env ${{ matrix.environment }} --quiet
  env:
    CLUSTER_ID: ${{ secrets.KAFKA_CLUSTER_ID }}
```

#### 7.7 è¿ç»´è„šæœ¬æ€»ç»“ ğŸ“‹ **æ¶æ„ä¼˜åŠ¿**

**v2.0 éƒ¨ç½²ç³»ç»Ÿç‰¹æ€§**:

| ç‰¹æ€§ç±»åˆ« | åŠŸèƒ½ | å®ç°æ•ˆæœ |
|---------|------|----------|
| **æ™ºèƒ½åŒ–** | è¡¨æ£€æµ‹ã€ç¯å¢ƒæ£€æµ‹ã€clean build | å¯é æ„å»ºï¼Œé¿å…ç¼“å­˜é—®é¢˜ |
| **æ¨¡å—åŒ–** | 7ä¸ªç‹¬ç«‹è„šæœ¬ï¼ŒèŒè´£å•ä¸€ | ä¾¿äºè°ƒè¯•ã€ç»´æŠ¤ã€æ‰©å±• |
| **åŒæ¨¡å¼** | è¯¦ç»†/é™é»˜ä¸¤ç§è¾“å‡ºæ¨¡å¼ | å¼€å‘å‹å¥½ + CI/CDä¼˜åŒ– |
| **ç¯å¢ƒç®¡ç†** | Local/AWS/Productionä¸€é”®åˆ‡æ¢ | æ”¯æŒå¤šç¯å¢ƒéƒ¨ç½²æµç¨‹ |
| **æµ‹è¯•éªŒè¯** | ç‹¬ç«‹CQRSæµç¨‹æµ‹è¯• | ç«¯åˆ°ç«¯éªŒè¯ï¼Œæ•…éšœå¿«é€Ÿå®šä½ |
| **æ—¥å¿—ç»Ÿä¸€** | å½©è‰²æ ‡ç­¾ï¼Œç»“æ„åŒ–è¾“å‡º | é—®é¢˜æ’æŸ¥æ•ˆç‡æå‡ |

**éƒ¨ç½²å¤æ‚åº¦é™ä½**:
- ğŸš€ **ä¸€é”®éƒ¨ç½²**: ä»å¤šæ­¥éª¤æ“ä½œç®€åŒ–ä¸ºå•å‘½ä»¤æ‰§è¡Œ
- ğŸ¯ **å¯é æ„å»º**: Maven clean packageç¡®ä¿ä»£ç å˜æ›´ç”Ÿæ•ˆï¼Œæ— ç¼“å­˜é—®é¢˜
- ğŸ”§ **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯æç¤ºå’Œæ¢å¤æœºåˆ¶
- ğŸ“ˆ **æ‰©å±•æ€§**: æ–°ç¯å¢ƒæ·»åŠ åªéœ€ä¿®æ”¹æ¨¡æ¿é…ç½®

### 8. é¡¹ç›®ç»“æ„è¯„ä¼°

#### 8.1 Spring Bootæœ€ä½³å®è·µç¬¦åˆåº¦: âœ… **ä¼˜ç§€**

**ä¼˜ç‚¹**:
- å¾®æœåŠ¡èŒè´£åˆ’åˆ†æ¸…æ™°
- é…ç½®ç®¡ç†è§„èŒƒ
- ä¾èµ–æ³¨å…¥ä½¿ç”¨å¾—å½“
- æµ‹è¯•ç»“æ„å®Œæ•´

#### 8.2 ä»£ç ç»„ç»‡ç»“æ„
```
PurchaseService/
â”œâ”€â”€ src/main/java/org/java/purchaseservice/
â”‚   â”œâ”€â”€ controller/          # RESTæ§åˆ¶å™¨
â”‚   â”œâ”€â”€ service/            # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ purchase/       # è´­ä¹°æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ redis/         # Redisæ“ä½œ
â”‚   â”‚   â””â”€â”€ initialize/    # åˆå§‹åŒ–æœåŠ¡
â”‚   â”œâ”€â”€ outbox/            # Outboxæ¨¡å¼å®ç°
â”‚   â”œâ”€â”€ config/            # é…ç½®ç±»
â”‚   â”œâ”€â”€ model/             # æ•°æ®æ¨¡å‹
â”‚   â””â”€â”€ exception/         # å¼‚å¸¸å¤„ç†
â””â”€â”€ src/main/resources/
    â”œâ”€â”€ application.yml     # åº”ç”¨é…ç½®
    â””â”€â”€ lua/               # Redis Luaè„šæœ¬
```

#### 8.3 é…ç½®ç®¡ç† âœ… **è‰¯å¥½**
- ç¯å¢ƒåˆ†ç¦»(æœ¬åœ°/Docker/ç”Ÿäº§)
- å¤–éƒ¨åŒ–é…ç½®
- å¥åº·æ£€æŸ¥é…ç½®

#### 8.4 ä¾èµ–ç®¡ç† âœ… **åˆç†**
- çˆ¶POMç»Ÿä¸€ç‰ˆæœ¬ç®¡ç†
- Spring Boot Starterä½¿ç”¨æ°å½“
- è¿æ¥æ± ä¼˜åŒ–(HikariCP)

## 9. æ¶æ„å®Œå–„æƒ…å†µä¸åç»­è§„åˆ’

### 9.1 å·²å®Œæˆçš„é‡å¤§æ”¹è¿› âœ…

#### 9.1.1 Java 21 LTSå‡çº§å®Œæˆ
- âœ… æ‰€æœ‰æœåŠ¡å‡çº§åˆ°Java 21
- âœ… è™šæ‹Ÿçº¿ç¨‹æ”¯æŒå°±ç»ª
- âœ… åˆ†ä»£å¼ZGCé…ç½®ä¼˜åŒ–

#### 9.1.2 Kafkaè¿ç§»å…¨é¢å®Œæˆ
- âœ… PurchaseService â†’ Kafkaç”Ÿäº§è€…
- âœ… MqProjectionService â†’ Kafkaæ¶ˆè´¹è€…  
- âœ… ç«¯åˆ°ç«¯æ¶ˆæ¯æµå®Œæ•´
- âœ… RabbitMQä¾èµ–å®Œå…¨ç§»é™¤

#### 9.1.3 æœåŠ¡å‘½åè§„èŒƒåŒ–
- âœ… RabbitCombinedConsumer â†’ MqProjectionService
- âœ… æ–‡ä»¶å¤¹ã€é…ç½®ã€DockeræœåŠ¡åç»Ÿä¸€æ›´æ–°
- âœ… Consumer Groupä¼˜åŒ–: ticketSqlSync

#### 9.1.4 éƒ¨ç½²æ¶æ„å…¨é¢å‡çº§ â­ **æœ€æ–°å®Œæˆ**
- âœ… **è„šæœ¬æ¶æ„é‡æ„**: 7ä¸ªæ¨¡å—åŒ–è„šæœ¬ï¼ŒèŒè´£å•ä¸€
- âœ… **åŒæ¨¡å¼æ”¯æŒ**: è¯¦ç»†/é™é»˜æ¨¡å¼é€‚é…å¼€å‘å’ŒCI/CD
- âœ… **ç¯å¢ƒç®¡ç†**: ä¸€é”®åˆ‡æ¢Local/AWS/Productionç¯å¢ƒ
- âœ… **æ™ºèƒ½æ£€æµ‹**: è¡¨/é›†ç¾¤IDæ™ºèƒ½æ£€æµ‹ï¼ŒMaven clean buildä¿è¯å¯é æ€§
- âœ… **ç‹¬ç«‹æµ‹è¯•**: å®Œæ•´çš„CQRSæµç¨‹éªŒè¯ç³»ç»Ÿ
- âœ… **ä»£ç ç®€åŒ–**: ç¯å¢ƒåˆ‡æ¢è„šæœ¬ä¼˜åŒ–20% (95â†’76è¡Œ)
- âœ… **ç»Ÿä¸€æ—¥å¿—**: å½©è‰²æ ‡ç­¾ç³»ç»Ÿï¼Œç»“æ„åŒ–è¾“å‡º

### 9.2 å½“å‰æ¶æ„ä¼˜åŠ¿ ğŸ’ª

1. **å®Œæ•´çš„CQRSå®ç°**: è¯»å†™åˆ†ç¦»æ¸…æ™°ï¼ŒèŒè´£æ˜ç¡®
2. **ç»Ÿä¸€äº‹ä»¶é©±åŠ¨**: å…¨é¢åŸºäºKafkaçš„æ¶ˆæ¯æµ
3. **é«˜æ€§èƒ½æŠ€æœ¯æ ˆ**: Java 21 + è™šæ‹Ÿçº¿ç¨‹ + ZGC
4. **ä¼ä¸šçº§éƒ¨ç½²**: æ¨¡å—åŒ–è„šæœ¬ + å¤šç¯å¢ƒæ”¯æŒ + æ™ºèƒ½æ£€æµ‹
5. **æ··åˆæ•°æ®è®¿é—®**: JPA(æŸ¥è¯¢) + JDBC(å†™å…¥) + AWS SDK(DynamoDB)
6. **å®Œæ•´æµ‹è¯•éªŒè¯**: ç‹¬ç«‹CQRSæµç¨‹æµ‹è¯•ç³»ç»Ÿ

### 9.3 ä¸‹ä¸€æ­¥å‘å±•è§„åˆ’

#### 9.3.1 çŸ­æœŸç›®æ ‡ (1-2å‘¨)
1. **è´­ç‰©è½¦æœåŠ¡å®ç°**: Redis(ä¸´æ—¶) + MySQL(æŒä¹…åŒ–)æ··åˆå­˜å‚¨
2. **æ€§èƒ½ä¼˜åŒ–**: è™šæ‹Ÿçº¿ç¨‹åœ¨é«˜å¹¶å‘åœºæ™¯çš„å…¨é¢åº”ç”¨
3. **ç›‘æ§å¢å¼º**: MicrometeræŒ‡æ ‡æ”¶é›†å’ŒPrometheusé›†æˆ

#### 9.3.2 ä¸­æœŸç›®æ ‡ (1-2ä¸ªæœˆ)  
1. **APIç½‘å…³**: Spring Cloud Gatewayç»Ÿä¸€å…¥å£
2. **å®Œæ•´ç›‘æ§**: Grafanaä»ªè¡¨ç›˜ + å‘Šè­¦ç³»ç»Ÿ
3. **å®‰å…¨åŠ å›º**: OAuth2 + JWTè®¤è¯æœºåˆ¶

## 10. æ¶æ„æ€»ç»“

### 10.1 é¡¹ç›®æŠ€æœ¯æˆç†Ÿåº¦è¯„ä¼° ğŸ†

**ä¼˜åŠ¿æ¸…å•**:
- âœ… **Java 21 LTS**: æœ€æ–°é•¿æœŸæ”¯æŒç‰ˆæœ¬ï¼Œè™šæ‹Ÿçº¿ç¨‹å°±ç»ª
- âœ… **å®Œæ•´CQRS**: DynamoDB(å†™) + MySQL(è¯») + Kafka(äº‹ä»¶æµ)
- âœ… **é«˜æ€§èƒ½è®¾è®¡**: RedisåŸå­é” + åˆ†ä»£ZGC + è™šæ‹Ÿçº¿ç¨‹
- âœ… **ç»Ÿä¸€æ¶ˆæ¯æ¶æ„**: å…¨é¢åŸºäºKafkaï¼ŒRabbitMQå·²å®Œå…¨ç§»é™¤
- âœ… **ä¼ä¸šçº§éƒ¨ç½²**: æ¨¡å—åŒ–è„šæœ¬ + åŒæ¨¡å¼ + å¤šç¯å¢ƒæ”¯æŒ
- âœ… **æ™ºèƒ½è‡ªåŠ¨åŒ–**: JARæ£€æµ‹ + è¡¨æ£€æµ‹ + ç¯å¢ƒæ£€æµ‹
- âœ… **å®Œæ•´æµ‹è¯•**: ç‹¬ç«‹CQRSéªŒè¯ + ç«¯åˆ°ç«¯æµç¨‹æµ‹è¯•
- âœ… **æœåŠ¡å‘½åè§„èŒƒ**: MqProjectionServiceè¯­ä¹‰æ¸…æ™°

**ä¼ä¸šçº§å°±ç»ªç¨‹åº¦**: **98%** - ç”Ÿäº§éƒ¨ç½² + è¿ç»´è‡ªåŠ¨åŒ–åŒé‡å°±ç»ª

### 10.2 ä¸‹ä¸€é˜¶æ®µé‡ç‚¹

1. **è´­ç‰©è½¦æœåŠ¡å®ç°** (Redis + MySQLæ··åˆå­˜å‚¨)
2. **æ€§èƒ½è°ƒä¼˜æ·±åŒ–** (è™šæ‹Ÿçº¿ç¨‹å…¨é¢åº”ç”¨)
3. **ç›‘æ§ä½“ç³»å®Œå–„** (Prometheus + Grafana)
4. **APIç½‘å…³é›†æˆ** (Spring Cloud Gateway)

### 10.3 æ¶æ„æˆç†Ÿåº¦é‡Œç¨‹ç¢‘ ğŸ¯

**å·²è¾¾æˆ (2025-09-28)**:
- ğŸš€ **æ ¸å¿ƒæ¶æ„**: CQRS + Event Sourcing + Kafkaç»Ÿä¸€æ¶ˆæ¯
- ğŸ”§ **éƒ¨ç½²è‡ªåŠ¨åŒ–**: ä¼ä¸šçº§è„šæœ¬ä½“ç³» + å¤šç¯å¢ƒæ”¯æŒ
- ğŸ§ª **æµ‹è¯•ä½“ç³»**: ç‹¬ç«‹CQRSéªŒè¯ + å¥åº·æ£€æŸ¥
- ğŸ’¾ **æ•°æ®æ¶æ„**: æ··åˆå­˜å‚¨ç­–ç•¥ä¼˜åŒ–
